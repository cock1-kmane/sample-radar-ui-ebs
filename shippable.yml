# language setting
language: node_js

# version numbers, testing against two versions of node
node_js:
  - 0.10.33

env:
  global:
    - AWS_EB_APPLICATION=node-app # existing EB application name
    - AWS_EB_ENVIRONMENT=nodeapp # existing EB environment name
    - AWS_S3_BUCKET=http://nodeapp.bd4cre3cz3.us-east-1.elasticbeanstalk.com/ # S3 bucket allowing EB access
    - AWS_S3_FOLDER=$AWS_EB_APPLICATION
    - AWS_REGION=us-east-1
    - REGISTRY_ACCOUNT=shippabledocker # Docker Hub account name
    - ACCOUNT_IDENTIFIER=shippable.$REGISTRY_ACCOUNT
    - AWS_DEPLOY_JSON=Dockerrun.aws.json.$ACCOUNT_IDENTIFIER.$AWS_EB_APPLICATION
    - AWS_DOCKER_CONFIG=dockerconfig.$ACCOUNT_IDENTIFIER.$AWS_EB_APPLICATION
    # encrypted variable for AWS_ACCESS_KEY_ID
    - secure: c5Th/DpT5P9kHJUBQUtCOwbf/7FdR/2eoV3ltYmBqjsExKLoJBVlhCJ8tu+50iWcUHcMeaMIy53Rz6+xEOW3ia59hykldo88HYxhEWjHPIVyvkBmHjIUMpJEhvY/HOE29MsJAs7AnKUl5IvNOYwtB9yNJzdW+n1kyj2L1X1azsaCUk7qZcEwxtzkGeyj5KBrPWgiY86Lr3f+UtIrpTWIkhih3vPKSkhWlh3eSQwj3p0IOejAUYFJVLXlJv2ZS0VonF0jdvB6ELmUPe2mArxWiHOQE18DfaFecnNch18u6e3u5omlqlwv3xa6oB8iFF5YD/z8KzsEBPUejETHqEd2Hw==    #- secure: DJVb1fX1kJID5oymfAbEY+hxwEiHOvoDGncAjiO+7YRS5Tph5o7PLJRjAUJRPSlON8Nsd9tmhjKVmxE1NGZT8H/ZOtfGUS08LsfoFnMHooPpAJW9xTUqSljmVpXsMHG7jByMUp/KX68LbqYnsug/E1JmxjB/NugGuNihoWbiDOqNo6OItavunGeerUnl/u7Sb8nbyZNWTaTRVDyjeKYPDOH5uiMdj2NR0r4v3kQfYG7XyTG96qZCW/BYtGmyLU4LoXqaElf8AZIK7OM0wxpDmQezocnNArTHcbqmo02Dgwc2BXxR/1eHfnJJ3i4vu7x39fsFZa/B1m/AqZzhEyO6NQ==
    # encrypted variable for AWS_SECRET_ACCESS_KEY
    - secure: E5PrBWGxvKNGFHOF/VEyJYzRgSXaM/sOcXuME+9uGJjfzHsKmbiVvdmZlFC3Hne+mNg3xlaGSeto2NzbmHYRjl7eZlCilpRxIL0s68irbwOQdEsWKFHhHmiajs/6heDsU2aGngwh4JoWngFszYIufUSFh3EzqfACEotUxl+t5Lp4IPm14iCWgSIj/dcC28BA228UmzGPfxmrYsPfhoZt+ONVRtQPdgbd0qsUZbcaAk21+0KBDGTxfa1llX9UVdYj1gB2LQN8mcogyE1Tajyxyt2G2fpA//Vk7NDr3TR/SvQgLO6LsAhQ+413mL77l/EhgjZss2wNdR9uaCQSBDaaGg==
     

build:
  pre_ci:
    - docker build -t $REGISTRY_ACCOUNT/$AWS_EB_APPLICATION:latest .
    - node --version
    - SUDO=$(which sudo) && $SUDO pip install awscli
  pre_ci_boot:
    image_name: $REGISTRY_ACCOUNT/$AWS_EB_APPLICATION
    image_tag: latest
    pull: false
    options: --privileged=true
  ci:
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set region $AWS_REGION
    - npm install
  post_ci:
    - docker tag -f $REGISTRY_ACCOUNT/$AWS_EB_APPLICATION:latest $REGISTRY_ACCOUNT/$AWS_EB_APPLICATION:$BRANCH.$BUILD_NUMBER
    - docker push $REGISTRY_ACCOUNT/$AWS_EB_APPLIC
    
integrations:
  hub:
    - integrationName: "ship-docker"
      type: docker
     
